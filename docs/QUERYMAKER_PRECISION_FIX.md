# QueryMaker 精准度优化

## 问题描述

用户查询："郭毅可什么时候可以当浸会大学校长？"

生成的搜索查询：
```
1. 郭毅可什么时候可以当浸会大学校长？  ✅ 原始问题
2. 郭毅可 任职资格 2025                 ✅ 相关
3. 浸会大学 校长任期 2026               ✅ 相关
4. 董事会 授权 校长 2025                ❌ 太泛化，离题
5. 教务处 评估 标准 2024                ❌ 完全偏离
```

**问题**：查询 4、5 虽然有多样性，但失去了与核心实体的关联，导致检索到不相关的信息。

---

## 根本原因

`QUERYMAKER_PROMPT` 中的指令：
```
- Introduce NEW entities not in the original query (at least 2 queries)
```

这个指令鼓励 LLM 引入新实体，但**没有明确要求新实体必须与核心实体保持关联**，导致：
- ❌ "董事会授权校长" - 泛化的流程，没有提到"郭毅可"或"浸会大学"
- ❌ "教务处评估标准" - 完全无关的主题

---

## 设计理念（保持不变）

用户明确表示：
> "问题的多样性和联想力是我需要的"

因此，我们**不削弱**现有的设计，而是**微调执行精准度**：
- ✅ 保持多样性（不同角度、时间、对比）
- ✅ 保持联想力（引入新实体、创造性思考）
- ✅ **新增**：确保新实体与核心实体保持关联

---

## 解决方案

### 修改 1: 明确"新实体"的关联要求

**修改前**：
```
- Introduce NEW entities not in the original query (at least 2 queries)
```

**修改后**：
```
- Introduce NEW entities not in the original query (at least 2 queries), BUT they MUST be directly connected to the CORE entities
  * Example: If asking about "郭毅可 浸会大学校长", new entities could be "前任校长", "校董会", "任命时间"
  * BAD: Generic entities like "董事会授权流程" or "教务处评估" without mentioning the core person/organization
```

**关键变化**：
- ✅ 保留"引入新实体"的要求（多样性）
- ✅ 新增"必须与核心实体直接关联"的约束（精准度）
- ✅ 提供正反例（GOOD vs BAD）

---

### 修改 2: 强调核心实体的重要性

**新增指令**：
```
- Include historical context AND future predictions, but always tie back to the CORE question
- Mix general and specific queries, with preference for specific ones that include core entity names
- Be creative - think of queries the user might not have considered, while maintaining relevance
```

**效果**：
- "tie back to the CORE question" - 始终回归核心问题
- "include core entity names" - 优先包含核心实体名称
- "while maintaining relevance" - 创造性的同时保持相关性

---

### 修改 3: 在示例中展示正确做法

**新增示例**：
```
Example 1 (精准示例 - 保持核心实体关联):
User: 郭毅可什么时候可以当浸会大学校长？
JSON:
{
  "topic": "郭毅可担任浸会大学校长时间",
  "entities_core": ["郭毅可","浸会大学","校长"],
  "entities_added": ["前任校长卫炳江","校董会","任命流程"],
  "slots": [
    {"slot":"BIO","queries":["郭毅可学术履历","郭毅可现任职位 2025"]},
    {"slot":"CURRENT","queries":["郭毅可浸会大学校长任命 2025","浸会大学新校长消息 2025"]},
    {"slot":"RULES","queries":["浸会大学校长任命流程","香港大学校长任期规定"]},
    {"slot":"COMPARISON","queries":["浸会大学前任校长卫炳江任期","郭毅可与前任校长背景对比"]},
    {"slot":"DATA","queries":["浸会大学历任校长名单","校长交接时间表"]}
  ]
}

**GOOD vs BAD Examples:**
✅ GOOD: "郭毅可浸会大学校长任命 2025" - 包含核心实体
✅ GOOD: "浸会大学前任校长任期" - 相关实体，有助于回答问题
❌ BAD: "董事会授权校长 2025" - 太泛化，没有提到郭毅可或浸会大学
❌ BAD: "教务处评估标准 2024" - 完全偏离主题
```

---

## 预期效果

### 修改前 ❌
```
1. 郭毅可什么时候可以当浸会大学校长？  ✅
2. 郭毅可 任职资格 2025                 ✅
3. 浸会大学 校长任期 2026               ✅
4. 董事会 授权 校长 2025                ❌ 泛化
5. 教务处 评估 标准 2024                ❌ 偏离
```

### 修改后 ✅
```
1. 郭毅可什么时候可以当浸会大学校长？      ✅ 原始问题
2. 郭毅可学术履历                         ✅ 背景信息
3. 郭毅可浸会大学校长任命 2025            ✅ 最新消息
4. 浸会大学前任校长卫炳江任期             ✅ 对比参考
5. 浸会大学校长任命流程                   ✅ 规则流程
```

**改进点**：
- ✅ 所有查询都包含核心实体（郭毅可 或 浸会大学）
- ✅ 保持多样性（背景、最新、对比、流程）
- ✅ 保持联想力（引入"前任校长"、"任命流程"等新角度）
- ✅ 精准度提升（不再有泛化或偏离的查询）

---

## 设计原则总结

### 保持的优势
1. **多样性** - 覆盖不同角度（BIO, CURRENT, RULES, COMPARISON, DATA）
2. **联想力** - 引入新实体和创造性角度
3. **时间感知** - 使用具体时间信息（2025, 2026）
4. **结构化** - 使用 slots 组织查询

### 新增的约束
1. **核心实体关联** - 新实体必须与核心实体直接相关
2. **相关性优先** - 具体查询优于泛化查询
3. **实体命名** - 优先在查询中包含核心实体名称

---

## 实施细节

### 文件修改
- **文件**: `src/actions/querymaker.py`
- **修改位置**: `QUERYMAKER_PROMPT` (第 33-75 行)
- **修改类型**: 微调提示词指令和示例

### 修改内容
1. **Query Diversity Guidelines** (第 42-50 行)
   - 新增"新实体必须与核心实体关联"的要求
   - 提供正反例
   - 强调"tie back to CORE question"

2. **Example 1** (第 55-75 行)
   - 使用用户的实际查询作为示例
   - 展示正确的实体关联方式
   - 添加 GOOD vs BAD 对比

---

## 测试验证

### 测试查询 1
**输入**: "郭毅可什么时候可以当浸会大学校长？"

**预期输出**:
```json
[
  "郭毅可什么时候可以当浸会大学校长？",
  "郭毅可学术背景",
  "郭毅可浸会大学校长任命 2025",
  "浸会大学校长任命流程",
  "浸会大学前任校长任期"
]
```

**验证标准**:
- ✅ 每个查询都包含"郭毅可"或"浸会大学"
- ✅ 覆盖不同角度（背景、最新、流程、对比）
- ✅ 没有泛化或偏离的查询

---

### 测试查询 2
**输入**: "香港今年中秋活动有哪些？"

**预期输出**:
```json
[
  "香港今年中秋活动有哪些？",
  "香港中秋节庆祝活动 2025",
  "香港维多利亚港中秋灯会 2025",
  "香港各区中秋活动时间表",
  "香港中秋节传统习俗"
]
```

**验证标准**:
- ✅ 每个查询都包含"香港"或"中秋"
- ✅ 引入新实体（维多利亚港、各区）但保持相关
- ✅ 包含时间信息（2025）

---

## 总结

### 核心改进
通过微调提示词，在**保持多样性和联想力**的同时，**提升精准度**：
- 明确"新实体必须与核心实体关联"
- 提供正反例指导
- 强调"回归核心问题"

### 设计哲学
- **不削弱创造力** - 仍然鼓励引入新实体和多角度思考
- **提升执行精准度** - 确保创造力服务于核心问题
- **平衡多样性与相关性** - 多样但不偏离

### 预期效果
- ✅ 减少离题查询（从 40% 降到 0%）
- ✅ 保持查询多样性（5-10 个不同角度）
- ✅ 提升检索质量（所有查询都相关且有价值）

---

最后更新: 2025-10-06
作者: AI Assistant
状态: ✅ 已优化并待测试
